#!/nix/store/xg75pc4yyfd5n2fimhb98ps910q5lm5n-bash-5.2p37/bin/bash

check_file() {
  local file="$1"
  local doc=""
  local doc_number=0
  local has_error=0

  while IFS= read -r line || [[ -n "$line" ]]; do
    # If document separator is hit, check current doc
    if [[ "$line" =~ ^---[[:space:]]*$ ]]; then
      if [[ -n "$doc" ]]; then
        ((doc_number++))
        if ! grep -q "^# yaml-language-server" <<< "$doc"; then
          echo "❌ Missing 'yaml-language-server' in document $doc_number of $file"
          has_error=1
        fi
      fi
      doc=""
      continue
    fi
    doc+="$line"$'\n'
  done < "$file"

  # Check final document if present
  if [[ -n "$doc" ]]; then
    ((doc_number++))
    if ! grep -q "^# yaml-language-server" <<< "$doc"; then
      echo "❌ Missing 'yaml-language-server' in document $doc_number of $file"
      has_error=1
    fi
  fi

  # If no document separator at all, treat as single doc
  if (( doc_number == 0 )); then
    if ! grep -q "^# yaml-language-server" "$file"; then
      echo "❌ Missing 'yaml-language-server' in document 1 of $file"
      has_error=1
    fi
  fi

  return $has_error
}

check_all_yaml_files() {
  local root_dir="$1"
  local any_errors=0

  while IFS= read -r -d '' file; do
    if ! check_file "$file"; then
      any_errors=1
    fi
  done < <(find "$root_dir" -type f \( -name '*.yaml' -o -name '*.yml' -o -name '*.yaml.j2' -o -name '*.yml.j2' \) -print0)

  return $any_errors
}

# === MAIN ===
ROOT_DIR="${1:-.}"

if check_all_yaml_files "$ROOT_DIR"; then
  echo "✅ All YAML documents contain 'yaml-language-server'."
  exit 0
else
  echo "❗ Some YAML documents are missing 'yaml-language-server'."
  exit 1
fi
